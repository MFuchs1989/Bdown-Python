---
title: Computer Vision - CNN with Transfer Learning
author: Michael Fuchs
date: '2021-01-17'
slug: computer-vision-cnn-with-transfer-learning
categories:
  - R
tags:
  - R Markdown
output:
  blogdown::html_page:
    toc: true
    toc_depth: 5
---


# 1 Introduction

In my post [Computer Vision - Convolutional Neural Network](https://michael-fuchs-python.netlify.app/2021/01/08/computer-vision-convolutional-neural-network/) I showed how to train a Convolutional Neural Network for binary image classification. Now I will try to improve this model again using Transfer Learning. 


For this publication I used the images from the *cats and dogs* dataset from the statistics platform ["Kaggle"](https://www.kaggle.com/c/dogs-vs-cats/data). You can download the used data from my ["GitHub Repository"](https://github.com/MFuchs1989/Datasets-and-Miscellaneous/tree/main/datasets/Computer%20Vision/Convolutional%20Neural%20Network). 



# 2 Import the libraries

```{r, eval=F, echo=T}
from preprocessing_CNN import Train_Validation_Test_Split

import numpy as np
import pandas as pd

import os
import shutil

import pickle as pk

import cv2 
import matplotlib.pyplot as plt
%matplotlib inline 

from keras import layers
from keras import models
from keras.callbacks import EarlyStopping, ModelCheckpoint
from keras.preprocessing.image import ImageDataGenerator
from keras.models import load_model

from keras.applications import VGG19
```



# 3 Data pre-processing

How the data for a CNN model training must be prepared I have already explained in this post: [Computer Vision - Convolutional Neural Network](https://michael-fuchs-python.netlify.app/2021/01/08/computer-vision-convolutional-neural-network/)

The exact functionality of the code I have explained in this post: [Automate the Boring Stuff](https://michael-fuchs-python.netlify.app/2021/01/01/computer-vision-automate-the-boring-stuff/#train-validation-test-split)

Please download the two folders *cats* and *dogs* from my ["GitHub Repository"](https://github.com/MFuchs1989/Datasets-and-Miscellaneous/tree/main/datasets/Computer%20Vision/Convolutional%20Neural%20Network) and navigate to the project's root directory in the terminal. The notebook must be started from the location where the two files are stored. 


## 3.1 Train-Validation-Test Split

For this please download the preprocessing_CNN.py file from my ["GitHub Repository"](https://github.com/MFuchs1989/Datasets-and-Miscellaneous/tree/main/datasets/Computer%20Vision/Convolutional%20Neural%20Network) and place this file next to the folders *cats* and *dogs* and start your Jupyter notebook from here.


```{r, eval=F, echo=T}
c_train, d_train, c_val, d_val, c_test, d_test = Train_Validation_Test_Split('cats', 'dogs')
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p1.png)


## 3.2 Obtaining the lists of randomly selected images

```{r, eval=F, echo=T}
list_cats_training = c_train
list_dogs_training = d_train

list_cats_validation = c_val
list_dogs_validation = d_val

list_cats_test = c_test
list_dogs_test = d_test
```


## 3.3 Determination of the directories


```{r, eval=F, echo=T}
root_directory = os.getcwd()

train_dir = os.path.join(root_directory, 'cats_and_dogs\\train')
validation_dir = os.path.join(root_directory, 'cats_and_dogs\\validation')
test_dir = os.path.join(root_directory, 'cats_and_dogs\\test')
```


## 3.4 Obtain the total number of training, validation and test images

```{r, eval=F, echo=T}
num_cats_img_train = len(list_cats_training)
num_dogs_img_train = len(list_dogs_training)

num_train_images_total = num_cats_img_train + num_dogs_img_train

print('Total training cat images: ' + str(num_cats_img_train))
print('Total training dog images: ' + str(num_dogs_img_train))
print()
print('Total training images: ' + str(num_train_images_total))
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p2.png)

```{r, eval=F, echo=T}
num_cats_img_validation = len(list_cats_validation)
num_dogs_img_validation = len(list_dogs_validation)

num_validation_images_total = num_cats_img_validation + num_dogs_img_validation

print('Total validation cat images: ' + str(num_cats_img_validation))
print('Total validation dog images: ' + str(num_dogs_img_validation))
print()
print('Total validation images: ' + str(num_validation_images_total))
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p3.png)


```{r, eval=F, echo=T}
num_cats_img_test = len(list_cats_test)
num_dogs_img_test = len(list_dogs_test)

num_test_images_total = num_cats_img_test + num_dogs_img_test

print('Total test cat images: ' + str(num_cats_img_test))
print('Total test dog images: ' + str(num_dogs_img_test))
print()
print('Total test images: ' + str(num_test_images_total))
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p4.png)



# 4 Feature Extraction without Data Augmentation

## 4.1 Name Definitions


```{r, eval=F, echo=T}
checkpoint_no = 'ckpt_1_CNN_with_TF_VGG19'
model_name = 'Cats_Dogs_CNN_TF_VGG19_epoch_30'
```

## 4.2 Parameter Settings


```{r, eval=F, echo=T}
img_height = 150
img_width = 150
input_shape = (img_height, img_width, 3)

n_batch_size = 32

n_epochs = 30

print('Input Shape: '+'('+str(img_height)+', '+str(img_width)+', ' + str(3)+')')
print('Batch Size: ' + str(n_batch_size))
print()
print('Number of Epochs: ' + str(n_epochs))
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p5.png)


## 4.3 Instantiating the VGG19 convolutional base

```{r, eval=F, echo=T}
VGG19_base = VGG19(weights='imagenet',
                  include_top=False,
                  input_shape=input_shape)

conv_base = VGG19_base
```

```{r, eval=F, echo=T}
conv_base.summary()
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p6.png)



## 4.4 Feature Extraction

### 4.4.1 Get Output Shape of last Layer

```{r, eval=F, echo=T}
df_temp = pd.DataFrame()

for layer in conv_base.layers:
    layer_output_shape = layer.output_shape

    df1 = {'Output_Shape': layer_output_shape}
    df_temp = df_temp.append(df1, ignore_index=True)

df_temp
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p7.png)

```{r, eval=F, echo=T}
df_temp = df_temp.loc[df_temp.index == df_temp.index.max()]
df_temp = df_temp['Output_Shape'].iloc[0]
df_temp
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p8.png)


```{r, eval=F, echo=T}
df_temp2 = pd.DataFrame(df_temp).T
df_temp2.columns= ['batch_size', 'pooled_rows', 'pooled_cols', 'channels']
df_temp2['pooled_rows'] = df_temp2['pooled_rows'].astype('int64')
df_temp2['pooled_cols'] = df_temp2['pooled_cols'].astype('int64')
df_temp2['channels'] = df_temp2['channels'].astype('int64')
df_temp2
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p9.png)


```{r, eval=F, echo=T}
n_pooled_rows = df_temp2['pooled_rows'].iloc[0]
n_pooled_cols = df_temp2['pooled_cols'].iloc[0]
n_channels = df_temp2['channels'].iloc[0]

print('Number of pooled rows: ' + str(n_pooled_rows))
print('Number of pooled cols: ' + str(n_pooled_cols))
print('Number of channels: ' + str(n_channels))
```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p10.png)


### 4.4.2 Extracting features using the pretrained convolutional base


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 4.4.3 Reshape train-, validation- and test features


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 4.5 Instantiating a densely connected classifier


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 4.5.1 Layer Structure


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 4.5.2 Configuring the model for training


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.6 Callbacks


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.7 Fitting the model


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.8 Obtaining the best model values


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.9 Obtaining class assignments


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.10 Validation


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.11 Load best model


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.12 Model Testing


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 4.13 Test Out of the Box Pictures


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



# 5 Feature Extraction with Data Augmentation


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.1 Name Definitions


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.2 Parameter Settings


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.3 Instantiating the VGG19 convolutional base


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.4 Instantiating a densely connected classifier


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 5.4.1 Layer Structure


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 5.4.2 Configuring the model for training


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



### 5.4.3 Using ImageDataGenerator


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.5 Callbacks


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.6 Fitting the model


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.7 Obtaining the best model values


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.8 Obtaining class assignments


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.9 Validation


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.10 Load best model


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.11 Model Testing


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



## 5.12 Test Out of the Box Pictures


```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)















```{r, eval=F, echo=T}

```

![](/post/2021-01-17-computer-vision-cnn-with-transfer-learning_files/p106p.png)



































































































































