---
title: NN - Artificial Neural Network for Regression Analysis
author: Michael Fuchs
date: '2021-03-02'
slug: nn-artificial-neural-network-for-regression-analysis
categories:
  - R
tags:
  - R Markdown
output:
  blogdown::html_page:
    toc: true
    toc_depth: 5
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>

<div id="TOC">
<ul>
<li><a href="#introduction">1 Introduction</a></li>
<li><a href="#loading-the-libraries">2 Loading the libraries</a></li>
<li><a href="#loading-the-data">3 Loading the data</a></li>
<li><a href="#data-pre-processing">4 Data pre-processing</a>
<ul>
<li><a href="#determination-of-the-predictors-and-the-criterion">4.1 Determination of the predictors and the criterion</a></li>
<li><a href="#train-validation-test-split">4.2 Train-Validation-Test Split</a></li>
<li><a href="#scaling">4.3 Scaling</a></li>
</ul></li>
<li><a href="#ann-for-regression">5 ANN for Regression</a>
<ul>
<li><a href="#name-definitions">5.1 Name Definitions</a></li>
<li><a href="#parameter-settings">5.2 Parameter Settings</a></li>
<li><a href="#layer-structure">5.3 Layer Structure</a></li>
<li><a href="#configuring-the-model-for-training">5.4 Configuring the model for training</a></li>
<li><a href="#callbacks">5.5 Callbacks</a></li>
<li><a href="#fitting-the-model">5.6 Fitting the model</a></li>
<li><a href="#obtaining-the-best-model-values">5.7 Obtaining the best model values</a></li>
<li><a href="#storing-all-necessary-metrics">5.8 Storing all necessary metrics</a></li>
</ul></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1>1 Introduction</h1>
<p>Now that I have shown how to solve classification problems (<a href="https://michael-fuchs-python.netlify.app/2021/02/16/nn-artificial-neural-network-for-binary-classification/">binary</a> and <a href="https://michael-fuchs-python.netlify.app/2021/02/23/nn-artificial-neural-network-for-multi-class-classfication/">multi-class</a>) with <a href="https://keras.io/">Keras</a>, I would like to show how to solve regression problems as well.</p>
<p>For this publication the dataset <em>House Sales in King County, USA</em> from the statistic platform <a href="https://www.kaggle.com">“Kaggle”</a> was used. You can download it from my <a href="https://github.com/MFuchs1989/Datasets-and-Miscellaneous/tree/main/datasets">“GitHub Repository”</a>.</p>
</div>
<div id="loading-the-libraries" class="section level1">
<h1>2 Loading the libraries</h1>
<pre class="r"><code>import pandas as pd
import numpy as np
import os
import shutil
import pickle as pk
import matplotlib.pyplot as plt

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler

from keras import models
from keras import layers
from keras.callbacks import EarlyStopping, ModelCheckpoint
from keras.models import load_model

from sklearn import metrics</code></pre>
</div>
<div id="loading-the-data" class="section level1">
<h1>3 Loading the data</h1>
<pre class="r"><code>df = pd.read_csv(&#39;house_prices.csv&#39;)
df = df.drop([&#39;id&#39;, &#39;date&#39;, &#39;yr_built&#39;, &#39;yr_renovated&#39;, &#39;zipcode&#39;, &#39;lat&#39;, &#39;long&#39;], axis=1)
df</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p1.png" /></p>
</div>
<div id="data-pre-processing" class="section level1">
<h1>4 Data pre-processing</h1>
<div id="determination-of-the-predictors-and-the-criterion" class="section level2">
<h2>4.1 Determination of the predictors and the criterion</h2>
<pre class="r"><code>x = df.drop(&#39;price&#39;, axis=1)
y = df[&#39;price&#39;]</code></pre>
</div>
<div id="train-validation-test-split" class="section level2">
<h2>4.2 Train-Validation-Test Split</h2>
<p>In the following, I will randomly assign 70% of the data to the training part and 15% each to the validation and test part.</p>
<pre class="r"><code>train_ratio = 0.70
validation_ratio = 0.15
test_ratio = 0.15

# Generate TrainX and TrainY
trainX, testX, trainY, testY = train_test_split(x, y, test_size= 1 - train_ratio)
# Genearate ValX, TestX, ValY and TestY
valX, testX, valY, testY = train_test_split(testX, testY, test_size=test_ratio/(test_ratio + validation_ratio))</code></pre>
<pre class="r"><code>print(trainX.shape)
print(valX.shape)
print(testX.shape)</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p2.png" /></p>
</div>
<div id="scaling" class="section level2">
<h2>4.3 Scaling</h2>
<pre class="r"><code>sc=StandardScaler()

scaler = sc.fit(trainX)

trainX_scaled = scaler.transform(trainX)
valX_scaled = scaler.transform(valX)
testX_scaled = scaler.transform(testX)</code></pre>
</div>
</div>
<div id="ann-for-regression" class="section level1">
<h1>5 ANN for Regression</h1>
<div id="name-definitions" class="section level2">
<h2>5.1 Name Definitions</h2>
<pre class="r"><code>checkpoint_no = &#39;ckpt_1_ANN&#39;
model_name = &#39;House_ANN_2FC_F64_64_epoch_120&#39;</code></pre>
</div>
<div id="parameter-settings" class="section level2">
<h2>5.2 Parameter Settings</h2>
<pre class="r"><code>input_shape = trainX.shape[1]

n_batch_size = 128

n_steps_per_epoch = int(trainX.shape[0] / n_batch_size)
n_validation_steps = int(valX.shape[0] / n_batch_size)
n_test_steps = int(testX.shape[0] / n_batch_size)

n_epochs = 120


print(&#39;Input Shape: &#39; + str(input_shape))
print(&#39;Batch Size: &#39; + str(n_batch_size))
print()
print(&#39;Steps per Epoch: &#39; + str(n_steps_per_epoch))
print()
print(&#39;Validation Steps: &#39; + str(n_validation_steps))
print(&#39;Test Steps: &#39; + str(n_test_steps))
print()
print(&#39;Number of Epochs: &#39; + str(n_epochs))</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p3.png" /></p>
</div>
<div id="layer-structure" class="section level2">
<h2>5.3 Layer Structure</h2>
<pre class="r"><code>model = models.Sequential()
model.add(layers.Dense(64, activation=&#39;relu&#39;, input_shape=(input_shape,)))
model.add(layers.Dense(64, activation=&#39;relu&#39;))
model.add(layers.Dense(1))</code></pre>
<pre class="r"><code>model.summary()</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p4.png" /></p>
</div>
<div id="configuring-the-model-for-training" class="section level2">
<h2>5.4 Configuring the model for training</h2>
<pre class="r"><code>model.compile(loss=&#39;mse&#39;,
              optimizer=&#39;rmsprop&#39;,
              metrics=[&#39;mae&#39;])</code></pre>
</div>
<div id="callbacks" class="section level2">
<h2>5.5 Callbacks</h2>
<p>If you want to know more about callbacks you can read about it here at <a href="https://keras.io/api/callbacks/">Keras</a> or also in my post about <a href="https://michael-fuchs-python.netlify.app/2021/01/08/computer-vision-convolutional-neural-network/#callbacks">Convolutional Neural Networks</a>.</p>
<pre class="r"><code># Prepare a directory to store all the checkpoints.
checkpoint_dir = &#39;./&#39;+ checkpoint_no
if not os.path.exists(checkpoint_dir):
    os.makedirs(checkpoint_dir)</code></pre>
<pre class="r"><code>keras_callbacks = [ModelCheckpoint(filepath = checkpoint_dir + &#39;/&#39; + model_name, 
                                   monitor=&#39;val_loss&#39;, save_best_only=True, mode=&#39;auto&#39;)]</code></pre>
</div>
<div id="fitting-the-model" class="section level2">
<h2>5.6 Fitting the model</h2>
<pre class="r"><code>history = model.fit(trainX_scaled,
                    trainY,
                    steps_per_epoch=n_steps_per_epoch,
                    epochs=n_epochs,
                    batch_size=n_batch_size,
                    validation_data=(valX_scaled, valY),
                    validation_steps=n_validation_steps,
                    callbacks=[keras_callbacks])</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p5.png" /></p>
</div>
<div id="obtaining-the-best-model-values" class="section level2">
<h2>5.7 Obtaining the best model values</h2>
<pre class="r"><code>hist_df = pd.DataFrame(history.history)
hist_df[&#39;epoch&#39;] = hist_df.index + 1
cols = list(hist_df.columns)
cols = [cols[-1]] + cols[:-1]
hist_df = hist_df[cols]
hist_df.to_csv(checkpoint_no + &#39;/&#39; + &#39;history_df_&#39; + model_name + &#39;.csv&#39;)
hist_df.head()</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p6.png" /></p>
<pre class="r"><code>values_of_best_model = hist_df[hist_df.val_loss == hist_df.val_loss.min()]
values_of_best_model</code></pre>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p7.png" /></p>
</div>
<div id="storing-all-necessary-metrics" class="section level2">
<h2>5.8 Storing all necessary metrics</h2>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p.png" /></p>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p.png" /></p>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p.png" /></p>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p.png" /></p>
<p><img src="/post/2021-03-02-nn-artificial-neural-network-for-regression-analysis_files/p114p.png" /></p>
</div>
</div>
